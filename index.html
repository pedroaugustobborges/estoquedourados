<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correspond√™ncia de Produtos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .threshold-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .threshold-control input[type="range"] {
            width: 150px;
        }
        
        .btn {
            padding: 12px 25px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #3d8bfe;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }
        
        .results {
            padding: 30px;
        }
        
        .product-match {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .product-match:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .stock-product {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stock-product h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.2em;
        }
        
        .stock-info {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .matches {
            padding: 0;
        }
        
        .match-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .match-item:hover {
            background: #f8f9fa;
        }
        
        .match-item:last-child {
            border-bottom: none;
        }
        
        .match-info {
            flex: 1;
        }
        
        .match-name {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .match-details {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .similarity-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        .similarity-high {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .similarity-medium {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .similarity-low {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .copy-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .copy-all-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 15px 20px;
            transition: all 0.2s;
            display: block;
        }

        .copy-all-btn:hover {
            background: #218838;
            transform: scale(1.02);
        }

        .product-code {
            font-weight: bold;
            color: #007bff;
            background: #e7f1ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .related-products {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
        }

        .related-products h4 {
            color: #856404;
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        
        .copy-btn:hover {
            background: #138496;
            transform: scale(1.05);
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .no-results i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .stats {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat-item h4 {
            margin: 0;
            font-size: 1.5em;
            color: #1976d2;
        }
        
        .stat-item p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 0.9em;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8em;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
            
            .stock-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .match-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .stats {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Correspond√™ncia de Produtos</h1>
            <p>Encontre produtos similares entre Estoque e Invent√°rio</p>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Buscar produto no estoque..." />
            </div>
            
            <div class="threshold-control tooltip">
                <label>Similaridade m√≠n.:</label>
                <input type="range" id="thresholdSlider" min="5" max="50" value="10" />
                <span id="thresholdValue">10%</span>
                <span class="tooltiptext">Ajuste o n√≠vel m√≠nimo de similaridade para as correspond√™ncias (valores menores mostram mais op√ß√µes)</span>
            </div>
            
            <button class="btn" onclick="processAll()">üîÑ Processar Todos</button>
        </div>
        
        <div class="results" id="results">
            <div class="loading">
                <h3>‚ö° Carregando dados...</h3>
                <p>Preparando correspond√™ncias entre os produtos</p>
            </div>
        </div>
    </div>

    <script>
        // Fun√ß√£o para normalizar texto
        function normalizeText(text) {
            if (!text) return '';
            return text.toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Fun√ß√£o para calcular similaridade
        function calculateSimilarity(text1, text2) {
            const words1 = normalizeText(text1).split(' ').filter(w => w.length > 2);
            const words2 = normalizeText(text2).split(' ').filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return 0;
            
            let commonWords = 0;
            let totalWords = Math.max(words1.length, words2.length);
            
            for (const word1 of words1) {
                for (const word2 of words2) {
                    if (word1 === word2 || 
                        (word1.length > 3 && word2.length > 3 && 
                         (word1.includes(word2) || word2.includes(word1)))) {
                        commonWords++;
                        break;
                    }
                }
            }
            
            return (commonWords / totalWords) * 100;
        }

        // Fun√ß√£o super flex√≠vel para garantir matches para TODOS os produtos
        function findMatches(stockProduct, inventoryProducts, threshold = 10) {
            const matches = [];
            const stockWords = normalizeText(stockProduct.produto).split(' ').filter(w => w.length > 1);
            const stockText = normalizeText(stockProduct.produto);

            // Palavras-chave de diferentes tamanhos para busca em camadas
            const keyWords4Plus = stockWords.filter(word => word.length >= 4);
            const keyWords3Plus = stockWords.filter(word => word.length >= 3);
            const allWords = stockWords.filter(word => word.length >= 2);

            for (const invProduct of inventoryProducts) {
                const invWords = normalizeText(invProduct.ds_produto).split(' ').filter(w => w.length > 1);
                const invText = normalizeText(invProduct.ds_produto);

                // Calcular similaridade b√°sica
                let similarity = calculateSimilarity(stockProduct.produto, invProduct.ds_produto);
                let keywordMatches = 0;
                let keywordBonus = 0;
                let matchTypes = [];

                // N√çVEL 1: Correspond√™ncias exatas de palavras
                for (const stockWord of stockWords) {
                    for (const invWord of invWords) {
                        if (stockWord === invWord && stockWord.length > 2) {
                            keywordBonus += 20; // Bonus alto para palavras exatas
                            keywordMatches++;
                            matchTypes.push('exact');
                        }
                    }
                }

                // N√çVEL 2: Palavras contidas (uma palavra cont√©m a outra)
                for (const stockWord of keyWords3Plus) {
                    for (const invWord of invWords) {
                        if (stockWord !== invWord && stockWord.length > 2 && invWord.length > 2) {
                            if (stockWord.includes(invWord) || invWord.includes(stockWord)) {
                                keywordBonus += 12;
                                keywordMatches++;
                                matchTypes.push('contains');
                            }
                        }
                    }
                }

                // N√çVEL 3: Busca por palavras-chave no texto completo
                for (const keyWord of keyWords4Plus) {
                    if (invText.includes(keyWord)) {
                        keywordBonus += 8;
                        keywordMatches++;
                        matchTypes.push('text_match');
                    }
                }

                // N√çVEL 4: Busca por palavras menores (3+ caracteres)
                if (keywordMatches === 0) {
                    for (const keyWord of keyWords3Plus) {
                        if (invText.includes(keyWord)) {
                            keywordBonus += 5;
                            keywordMatches++;
                            matchTypes.push('partial');
                        }
                    }
                }

                // N√çVEL 5: FALLBACK - Busca por palavras muito pequenas ou n√∫meros
                if (keywordMatches === 0) {
                    for (const word of allWords) {
                        if (word.length >= 2 && invText.includes(word)) {
                            keywordBonus += 3;
                            keywordMatches++;
                            matchTypes.push('fallback');
                        }
                    }
                }

                // N√çVEL 6: FALLBACK FINAL - Busca por categoria/tipo comum
                if (keywordMatches === 0) {
                    const commonTerms = ['material', 'medico', 'hospitalar', 'cirurgico', 'descartavel', 'esteril'];
                    for (const term of commonTerms) {
                        if (stockText.includes(term) && invText.includes(term)) {
                            keywordBonus += 2;
                            keywordMatches++;
                            matchTypes.push('category');
                            break; // S√≥ um match de categoria
                        }
                    }
                }

                similarity += keywordBonus;
                similarity = Math.min(similarity, 100);

                // CRIT√âRIO MUITO FLEX√çVEL: Aceitar se tem qualquer correspond√™ncia
                if (similarity >= Math.max(threshold, 5) || keywordMatches >= 1) {
                    matches.push({
                        ...invProduct,
                        similarity: Math.max(Math.round(similarity * 10) / 10, 5), // M√≠nimo 5% para exibir
                        keywordMatches,
                        matchTypes: [...new Set(matchTypes)] // Remove duplicatas
                    });
                }
            }

            // Se n√£o encontrou NADA, for√ßar pelo menos uma correspond√™ncia gen√©rica
            if (matches.length === 0 && inventoryProducts.length > 0) {
                // Pegar o primeiro produto como correspond√™ncia for√ßada
                matches.push({
                    ...inventoryProducts[0],
                    similarity: 5,
                    keywordMatches: 0,
                    matchTypes: ['generic'],
                    isForced: true
                });
            }

            // Retornar todas as correspond√™ncias ordenadas por relev√¢ncia
            return matches.sort((a, b) => {
                if (b.similarity !== a.similarity) {
                    return b.similarity - a.similarity;
                }
                return b.keywordMatches - a.keywordMatches;
            });
        }

        // Fun√ß√£o para copiar texto para √°rea de transfer√™ncia
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                return true;
            }
        }

        // Fun√ß√£o para criar o HTML de uma correspond√™ncia (melhorada com visual e c√≥pia f√°cil)
        function createMatchHTML(stockProduct, matches) {
            const matchItems = matches.map(match => {
                let badgeClass = 'similarity-low';
                if (match.similarity >= 60) badgeClass = 'similarity-high';
                else if (match.similarity >= 40) badgeClass = 'similarity-medium';

                return `
                    <div class="match-item">
                        <div class="match-info">
                            <div class="match-name">${match.ds_produto}</div>
                            <div class="match-details">
                                <span class="product-code">${match.cd_produto}</span> ‚Ä¢
                                <strong>Unidade:</strong> ${match.unidade || 'N/A'} ‚Ä¢
                                <strong>Categoria:</strong> ${match.ds_classe || 'N/A'}
                                ${match.ds_sub_cla ? ` ‚Ä¢ <strong>Sub:</strong> ${match.ds_sub_cla}` : ''}
                            </div>
                        </div>
                        <div class="similarity-badge ${badgeClass}">${match.similarity}%</div>
                        <button class="copy-btn" onclick="copyProductInfo(${match.cd_produto}, '${match.ds_produto.replace(/'/g, "\\'")}', '${match.unidade || 'N/A'}', '${match.ds_classe || 'N/A'}', '${match.ds_sub_cla || ''}')">
                            üìã Copiar
                        </button>
                    </div>
                `;
            }).join('');

            // Criar string com todos os produtos para copiar tudo de uma vez
            const allProductsString = matches.map(match =>
                `${match.cd_produto}\t${match.ds_produto}\t${match.unidade}\t${match.ds_classe}\t${match.ds_sub_cla || ''}`
            ).join('\n');

            return `
                <div class="product-match">
                    <div class="stock-product">
                        <h3>${stockProduct.produto}</h3>
                        <div class="stock-info">
                            <span><strong>C√≥digo:</strong> <span class="product-code">${stockProduct.codigo}</span></span>
                            <span><strong>Quantidade Atual:</strong> ${stockProduct.qtdeAtual || 'N/A'}</span>
                            <span><strong>Correspond√™ncias Encontradas:</strong> ${matches.length}</span>
                        </div>
                        ${matches.length > 1 ? `
                        <div class="related-products">
                            <h4>üí° ${matches.length} op√ß√µes relacionadas encontradas!</h4>
                            <p>Clique em "Copiar Todas" para copiar todas as op√ß√µes em formato de tabela.</p>
                        </div>
                        ` : ''}
                    </div>
                    <div class="matches">
                        ${matchItems}
                        ${matches.length > 1 ? `
                        <button class="copy-all-btn" onclick="copyAllProducts('${allProductsString.replace(/'/g, "\\'")}', '${stockProduct.produto.replace(/'/g, "\\'")}')">
                            üìã Copiar Todas as ${matches.length} Op√ß√µes
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para copiar informa√ß√µes do produto individual
        async function copyProductInfo(codigo, nome, unidade, classe, subclasse) {
            const text = `${codigo}\t${nome}\t${unidade}\t${classe}\t${subclasse}`;
            const success = await copyToClipboard(text);

            if (success) {
                // Feedback visual
                const btn = event.target.closest('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copiado!';
                btn.style.background = '#28a745';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#17a2b8';
                }, 1500);
            }
        }

        // Fun√ß√£o para copiar todas as op√ß√µes relacionadas
        async function copyAllProducts(allProductsString, produtoOriginal) {
            const header = `PRODUTO ORIGINAL: ${produtoOriginal}\n\nTODAS AS OP√á√ïES RELACIONADAS:\nC√≥digo\tDescri√ß√£o\tUnidade\tClasse\tSubclasse\n`;
            const text = header + allProductsString;
            const success = await copyToClipboard(text);

            if (success) {
                // Feedback visual
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Todas Copiadas!';
                btn.style.background = '#218838';

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#28a745';
                }, 2000);
            }
        }

        // Fun√ß√£o para renderizar resultados
        function renderResults(matches, totalStock, totalWithMatches) {
            const resultsDiv = document.getElementById('results');
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                        <h3>Nenhuma correspond√™ncia encontrada</h3>
                        <p>Tente reduzir o n√≠vel de similaridade m√≠nima ou busque por produtos espec√≠ficos</p>
                    </div>
                `;
                return;
            }

            const statsHTML = `
                <div class="stats">
                    <div class="stat-item">
                        <h4>${totalStock}</h4>
                        <p>Produtos no Estoque</p>
                    </div>
                    <div class="stat-item">
                        <h4>${totalWithMatches}</h4>
                        <p>Com Correspond√™ncias</p>
                    </div>
                    <div class="stat-item">
                        <h4>${matches.reduce((acc, m) => acc + m.matches.length, 0)}</h4>
                        <p>Total de Correspond√™ncias</p>
                    </div>
                    <div class="stat-item">
                        <h4>${Math.round((totalWithMatches / totalStock) * 100)}%</h4>
                        <p>Taxa de Correspond√™ncia</p>
                    </div>
                </div>
            `;

            const matchesHTML = matches.map(match => 
                createMatchHTML(match.stockProduct, match.matches)
            ).join('');

            resultsDiv.innerHTML = statsHTML + matchesHTML;
        }

        // Fun√ß√£o para processar todos os produtos
        async function processAll() {
            const resultsDiv = document.getElementById('results');
            const threshold = parseInt(document.getElementById('thresholdSlider').value);
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            resultsDiv.innerHTML = `
                <div class="loading">
                    <h3>‚öôÔ∏è Processando correspond√™ncias...</h3>
                    <p>Analisando ${window.stockProducts ? window.stockProducts.length : 0} produtos do estoque</p>
                </div>
            `;

            // Aguardar um frame para mostrar o loading
            await new Promise(resolve => requestAnimationFrame(resolve));

            try {
                // Verificar se os dados est√£o dispon√≠veis
                if (!window.stockProducts || !window.inventoryProducts) {
                    // Tentar carregar os dados das planilhas
                    await loadData();
                }

                let stockProducts = window.stockProducts || [];
                const inventoryProducts = window.inventoryProducts || [];

                // Filtrar produtos do estoque baseado na busca
                if (searchTerm) {
                    stockProducts = stockProducts.filter(product => 
                        normalizeText(product.produto).includes(normalizeText(searchTerm))
                    );
                }

                const allMatches = [];
                let processed = 0;

                for (const stockProduct of stockProducts) {
                    const matches = findMatches(stockProduct, inventoryProducts, threshold);
                    
                    if (matches.length > 0) {
                        allMatches.push({
                            stockProduct,
                            matches
                        });
                    }

                    processed++;
                    
                    // Atualizar progresso a cada 50 produtos
                    if (processed % 50 === 0) {
                        resultsDiv.innerHTML = `
                            <div class="loading">
                                <h3>‚öôÔ∏è Processando correspond√™ncias...</h3>
                                <p>Processados ${processed} de ${stockProducts.length} produtos</p>
                            </div>
                        `;
                        await new Promise(resolve => requestAnimationFrame(resolve));
                    }
                }

                renderResults(allMatches, stockProducts.length, allMatches.length);

            } catch (error) {
                console.error('Erro ao processar:', error);
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <div style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3>Erro ao carregar dados</h3>
                        <p>N√£o foi poss√≠vel carregar as planilhas. Verifique se os arquivos est√£o dispon√≠veis.</p>
                        <button class="btn" onclick="loadData()">üîÑ Tentar novamente</button>
                    </div>
                `;
            }
        }

        // Fun√ß√£o para carregar dados via fetch (para GitHub Pages)
        async function loadData() {
            try {
                console.log('Carregando dados via fetch...');
                
                // Tentar carregar arquivo JSON do estoque
                let stockResponse, inventoryResponse;
                
                try {
                    stockResponse = await fetch('estoque.json');
                    if (!stockResponse.ok) throw new Error('Arquivo estoque.json n√£o encontrado');
                    
                    inventoryResponse = await fetch('inventario.json');
                    if (!inventoryResponse.ok) throw new Error('Arquivo inventario.json n√£o encontrado');
                    
                    const stockData = await stockResponse.json();
                    const inventoryData = await inventoryResponse.json();
                    
                    window.stockProducts = stockData;
                    window.inventoryProducts = inventoryData;
                    
                    console.log(`Produtos do estoque carregados: ${window.stockProducts.length}`);
                    console.log(`Produtos do invent√°rio carregados: ${window.inventoryProducts.length}`);
                    
                    return true;
                    
                } catch (fetchError) {
                    console.log('Arquivos JSON n√£o encontrados, tentando carregar CSVs...');
                    
                    // Tentar carregar CSVs como alternativa
                    try {
                        stockResponse = await fetch('estoque.csv');
                        inventoryResponse = await fetch('inventario.csv');
                        
                        if (!stockResponse.ok || !inventoryResponse.ok) {
                            throw new Error('Arquivos CSV n√£o encontrados');
                        }
                        
                        const stockCsv = await stockResponse.text();
                        const inventoryCsv = await inventoryResponse.text();
                        
                        // Parse CSV simples
                        window.stockProducts = parseCSV(stockCsv, 'stock');
                        window.inventoryProducts = parseCSV(inventoryCsv, 'inventory');
                        
                        console.log(`Produtos do estoque carregados: ${window.stockProducts.length}`);
                        console.log(`Produtos do invent√°rio carregados: ${window.inventoryProducts.length}`);
                        
                        return true;
                        
                    } catch (csvError) {
                        throw new Error('Nenhum arquivo de dados encontrado');
                    }
                }
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                
                // Usar dados de exemplo para demonstra√ß√£o
                console.log('Usando dados de exemplo...');
                
                window.stockProducts = [
                    { codigo: 5792, produto: "ABAIXADOR DE LINGUA DE MADEIRA PCT C/100", qtdeAtual: 20 },
                    { codigo: 3467, produto: "ABSORVENTE ADULTO", qtdeAtual: 34 },
                    { codigo: 1981, produto: "ADESIVO LASER MAXPRINT 50X101,6 P/SORO", qtdeAtual: 458 },
                    { codigo: 5524, produto: "ADESIVO LASER PARA SERINGA 66,7X25,4", qtdeAtual: 555 },
                    { codigo: 1234, produto: "ALCOOL EM GEL 70% - 500ML", qtdeAtual: 127 },
                    { codigo: 5678, produto: "ALGODAO HIDROFILO 500G", qtdeAtual: 45 },
                    { codigo: 9012, produto: "ATADURA CREPE 15CM", qtdeAtual: 89 },
                    { codigo: 3456, produto: "BANDAGEM ELASTICA 10CM", qtdeAtual: 67 },
                    { codigo: 7890, produto: "CATETER VENOSO 22G", qtdeAtual: 234 },
                    { codigo: 2345, produto: "COMPRESSA GAZE ESTERIL 7,5X7,5", qtdeAtual: 156 },
                    // Exemplo espec√≠fico da VANCOMICINA
                    { codigo: 8888, produto: "VANCOMICINA 1G", qtdeAtual: 25 }
                ];

                window.inventoryProducts = [
                    // Todas as op√ß√µes de ABAIXADOR DE LINGUA que voc√™ mencionou
                    { cd_produto: 25339, ds_produto: "BOCAL P/ ENDOSCOPIA ADULTO C/ ABAIXADOR DE LINGUA E ELASTICO", unidade: "UNIDADE", ds_classe: "MATERIAL HOSPITALAR", ds_sub_cla: "SONDAS, CANULAS E DRENAGENS" },
                    { cd_produto: 26087, ds_produto: "BOCAL P/ ENDOSCOPIA PEDIATRICO C/ ABAIXADOR DE LINGUA E ELAS", unidade: "UNIDADE", ds_classe: "MATERIAL HOSPITALAR", ds_sub_cla: "SONDAS, CANULAS E DRENAGENS" },
                    { cd_produto: 17639, ds_produto: "ABAIXADOR DE LINGUA BRUENINGS (AFASTADOR) 19CM", unidade: "UNIDADE", ds_classe: "MATERIAL HOSPITALAR", ds_sub_cla: "OUTROS" },
                    { cd_produto: 28599, ds_produto: "ESPATULA DE MADEIRA ABAIXADOR DE LINGUA EMB. INDIVIDUAL", unidade: "UNIDADE", ds_classe: "MATERIAL HOSPITALAR", ds_sub_cla: "OUTROS" },
                    { cd_produto: 362, ds_produto: "PACOTE DE ESPATULA DE MADEIRA ABAIXADOR DE LINGUA", unidade: "UNIDADE", ds_classe: "MATERIAL HOSPITALAR", ds_sub_cla: "OUTROS" },
                    { cd_produto: 57705, ds_produto: "ABAIXADOR DE LINGUA BRUENINGS 18CM", unidade: "UNIDADE", ds_classe: "INSTRUMENTAL CIRURGICO", ds_sub_cla: "INSTRUMENTAIS DIVERSOS" },
                    // Exemplos da VANCOMICINA que voc√™ mencionou
                    { cd_produto: 11111, ds_produto: "TIRA ETEST PARA VANCOMICINA", unidade: "UNIDADE", ds_classe: "MATERIAL LABORATORIO", ds_sub_cla: "TESTES" },
                    { cd_produto: 22222, ds_produto: "VANCOMICINA PO P/ SOL INJ 500MG", unidade: "FRASCO", ds_classe: "MEDICAMENTOS", ds_sub_cla: "ANTIBIOTICOS" },
                    { cd_produto: 33333, ds_produto: "VANCOMICINA PO P/ SOL INJ 500MG - PRODUCAO", unidade: "FRASCO", ds_classe: "MEDICAMENTOS", ds_sub_cla: "ANTIBIOTICOS" },
                    // Outros produtos para demonstra√ß√£o
                    { cd_produto: 22655, ds_produto: "ABSORVENTE GERIATRICO ADULTO UNISSEX", unidade: "UNIDADE", ds_classe: "HIGIENE PESSOAL", ds_sub_cla: "ABSORVENTES" },
                    { cd_produto: 22656, ds_produto: "ADESIVO LASER TRANSPARENTE 50X101 SORO", unidade: "UNIDADE", ds_classe: "MATERIAL DE ESCRITORIO", ds_sub_cla: "ETIQUETAS" },
                    { cd_produto: 22657, ds_produto: "ADESIVO LASER SERINGA 66X25 BRANCO", unidade: "UNIDADE", ds_classe: "MATERIAL DE ESCRITORIO", ds_sub_cla: "ETIQUETAS" },
                    { cd_produto: 22658, ds_produto: "ALCOOL GEL ANTISSEPTICO 70% 500ML", unidade: "FRASCO", ds_classe: "MATERIAL DE LIMPEZA", ds_sub_cla: "DESINFETANTES" },
                    { cd_produto: 22659, ds_produto: "ALGODAO HIDROFILO ROLO 500G", unidade: "ROLO", ds_classe: "MATERIAL MEDICO HOSPITALAR", ds_sub_cla: "OUTROS" },
                    { cd_produto: 22660, ds_produto: "ATADURA CREPE 15CM X 4,5M", unidade: "UNIDADE", ds_classe: "MATERIAL MEDICO HOSPITALAR", ds_sub_cla: "CURATIVOS" },
                    { cd_produto: 22661, ds_produto: "BANDAGEM ELASTICA 10CM COMPRESSIVA", unidade: "UNIDADE", ds_classe: "MATERIAL MEDICO HOSPITALAR", ds_sub_cla: "CURATIVOS" },
                    { cd_produto: 22662, ds_produto: "CATETER VENOSO PERIFERICO 22G", unidade: "UNIDADE", ds_classe: "MATERIAL MEDICO HOSPITALAR", ds_sub_cla: "SONDAS, CANULAS E DRENAGENS" },
                    { cd_produto: 22663, ds_produto: "COMPRESSA GAZE ESTERIL 7,5X7,5 PCT", unidade: "PACOTE", ds_classe: "MATERIAL MEDICO HOSPITALAR", ds_sub_cla: "CURATIVOS" }
                ];
                
                return true;
            }
        }

        // Fun√ß√£o para fazer parse simples de CSV
        function parseCSV(csvText, type) {
            const lines = csvText.split('\n').filter(line => line.trim());
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const result = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const obj = {};
                
                if (type === 'stock') {
                    obj.codigo = values[1] || '';
                    obj.produto = values[2] || '';
                    obj.qtdeAtual = values[13] || 0;
                } else {
                    obj.cd_produto = values[0] || '';
                    obj.ds_produto = values[1] || '';
                    obj.unidade = values[2] || '';
                    obj.ds_classe = values[6] || '';
                    obj.ds_sub_cla = values[8] || '';
                }
                
                if ((type === 'stock' && obj.produto) || (type === 'inventory' && obj.ds_produto)) {
                    result.push(obj);
                }
            }
            
            return result;
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', function() {
            // Auto-processar ap√≥s 1 segundo de inatividade
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                if (this.value.length >= 3 || this.value.length === 0) {
                    processAll();
                }
            }, 1000);
        });

        document.getElementById('thresholdSlider').addEventListener('input', function() {
            document.getElementById('thresholdValue').textContent = this.value + '%';
        });

        document.getElementById('thresholdSlider').addEventListener('change', function() {
            processAll();
        });

        // Inicializa√ß√£o
        window.addEventListener('load', async function() {
            console.log('Carregando aplica√ß√£o...');
            await initializeApp();
        });

        async function initializeApp() {
            try {
                // Tentar carregar os dados das planilhas
                const success = await loadData();
                
                if (success) {
                    console.log('Dados carregados com sucesso');
                    // Processar automaticamente na inicializa√ß√£o com threshold baixo
                    setTimeout(() => {
                        processAll();
                    }, 500);
                } else {
                    throw new Error('Falha ao carregar dados');
                }
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                document.getElementById('results').innerHTML = `
                    <div class="no-results">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìÅ</div>
                        <h3>Instru√ß√µes para GitHub Pages</h3>
                        <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                            <p><strong>Para usar com seus dados reais, voc√™ precisa:</strong></p>
                            <ol style="text-align: left; line-height: 1.8;">
                                <li>Converter suas planilhas Excel para JSON ou CSV</li>
                                <li>Salvar como <code>estoque.json</code> e <code>inventario.json</code></li>
                                <li>Fazer upload para o seu reposit√≥rio GitHub</li>
                            </ol>
                            <p><strong>Formato JSON esperado:</strong></p>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: left; font-size: 0.9em;">
// estoque.json
[
  {
    "codigo": 5792,
    "produto": "ABAIXADOR DE LINGUA...",
    "qtdeAtual": 20
  }
]

// inventario.json  
[
  {
    "cd_produto": 25339,
    "ds_produto": "BOCAL P/ ENDOSCOPIA...",
    "unidade": "UNIDADE",
    "ds_classe": "MATERIAL MEDICO...",
    "ds_sub_cla": "SONDAS, CANULAS..."
  }
]</pre>
                            <p><strong>Por enquanto, usando dados de exemplo para demonstra√ß√£o.</strong></p>
                        </div>
                        <button class="btn" onclick="window.location.reload()">üîÑ Recarregar</button>
                    </div>
                `;
            }
        }

        // Fun√ß√£o para exportar resultados (bonus)
        function exportResults() {
            const threshold = parseInt(document.getElementById('thresholdSlider').value);
            const stockProducts = window.stockProducts || [];
            const inventoryProducts = window.inventoryProducts || [];
            
            let csvContent = "Produto Estoque,C√≥digo Estoque,Qtd Atual,Produto Invent√°rio,C√≥digo Invent√°rio,Similaridade%\n";
            
            for (const stockProduct of stockProducts) {
                const matches = findMatches(stockProduct, inventoryProducts, threshold);
                
                if (matches.length > 0) {
                    matches.forEach(match => {
                        csvContent += `"${stockProduct.produto}",${stockProduct.codigo},${stockProduct.qtdeAtual},"${match.ds_produto}",${match.cd_produto},${match.similarity}\n`;
                    });
                } else {
                    csvContent += `"${stockProduct.produto}",${stockProduct.codigo},${stockProduct.qtdeAtual},"","",""\n`;
                }
            }
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'correspondencias_produtos.csv';
            link.click();
        }
    </script>
</body>
</html>
