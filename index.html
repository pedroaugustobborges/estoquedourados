<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correspond√™ncia de Produtos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }
        
        .threshold-control select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .threshold-control select:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        .btn {
            padding: 12px 25px;
            background: #4facfe;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #3d8bfe;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
        }
        
        .results {
            padding: 30px;
        }
        
        .product-match {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .product-match:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .stock-product {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .stock-product h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.2em;
        }
        
        .stock-info {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .matches {
            padding: 0;
        }
        
        .match-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .match-item:hover {
            background: #f8f9fa;
        }
        
        .match-item:last-child {
            border-bottom: none;
        }
        
        .match-info {
            flex: 1;
        }
        
        .match-name {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .match-details {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .similarity-badge {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-left: 15px;
        }
        
        .similarity-high {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .similarity-medium {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .similarity-low {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .copy-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .copy-all-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            margin: 15px 20px;
            transition: all 0.2s;
            display: block;
        }

        .copy-all-btn:hover {
            background: #218838;
            transform: scale(1.02);
        }

        .product-code {
            font-weight: bold;
            color: #007bff;
            background: #e7f1ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 30px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .pagination button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .pagination-info {
            margin: 0 20px;
            color: #6c757d;
            font-size: 14px;
        }

        .pagination-summary {
            background: #e3f2fd;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            color: #1976d2;
            border-bottom: 1px solid #e9ecef;
        }
        
        .copy-btn:hover {
            background: #138496;
            transform: scale(1.05);
        }
        
        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
        
        .no-results i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .low-similarity-warning {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            margin: 0 20px 15px 20px;
            padding: 15px;
            border-radius: 0 8px 8px 0;
        }
        .low-similarity-warning h4 {
            margin: 0 0 5px 0;
            color: #856404;
            font-size: 1.1em;
        }
        .low-similarity-warning p {
            margin: 0;
            color: #856404;
            font-size: 0.95em;
        }
        .no-matches-found {
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: auto;
            }
            
            .stock-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .match-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Correspond√™ncia de Produtos</h1>
            <p>Encontre produtos similares entre Estoque e Invent√°rio</p>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç Buscar produto no estoque..." />
            </div>
            
            <div class="threshold-control">
                <label>Itens por p√°gina:</label>
                <select id="itemsPerPageSelect" onchange="changeItemsPerPage()">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>

            <button class="btn" onclick="processAll()">üîÑ Processar Todos</button>
        </div>
        
        <div class="results" id="results">
            <div class="loading">
                <h3>‚ö° Carregando dados...</h3>
                <p>Preparando correspond√™ncias entre os produtos</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ïES GLOBAIS ---
        const HIGH_SIMILARITY_THRESHOLD = 60; // Define o que √© uma "boa" correspond√™ncia
        let currentPage = 1;
        let itemsPerPage = 10;
        let allMatchesData = []; // Armazena os dados da busca atual para pagina√ß√£o
        let totalItems = 0;

        // Fun√ß√£o para normalizar texto (remover acentos, pontua√ß√£o e converter para min√∫sculas)
        function normalizeText(text) {
            if (!text) return '';
            return text.toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Fun√ß√£o para calcular a similaridade entre dois textos
        function calculateSimilarity(text1, text2) {
            const words1 = normalizeText(text1).split(' ').filter(w => w.length > 2);
            const words2 = normalizeText(text2).split(' ').filter(w => w.length > 2);
            
            if (words1.length === 0 || words2.length === 0) return 0;
            
            let commonWords = 0;
            const totalWords = Math.max(words1.length, words2.length);
            
            for (const word1 of words1) {
                for (const word2 of words2) {
                    if (word1 === word2 || (word1.length > 3 && word2.length > 3 && (word1.includes(word2) || word2.includes(word1)))) {
                        commonWords++;
                        break;
                    }
                }
            }
            
            return (commonWords / totalWords) * 100;
        }

        // Fun√ß√£o para encontrar correspond√™ncias com l√≥gica de b√¥nus
        function findMatches(stockProduct, inventoryProducts) {
            const allCalculatedMatches = [];
            const stockText = normalizeText(stockProduct.produto);

            for (const invProduct of inventoryProducts) {
                const invText = normalizeText(invProduct.ds_produto);
                let similarity = calculateSimilarity(stockText, invText);
                let bonus = 0;
                
                // B√¥nus por palavras exatas
                const stockWords = stockText.split(' ').filter(w => w.length > 2);
                const invWords = invText.split(' ').filter(w => w.length > 2);
                let commonCount = 0;
                stockWords.forEach(sw => {
                    if (invWords.includes(sw)) {
                        bonus += 15;
                        commonCount++;
                    }
                });

                if (commonCount > 1) bonus += commonCount * 5;

                similarity += bonus;
                
                allCalculatedMatches.push({
                    ...invProduct,
                    similarity: Math.min(Math.round(similarity), 100)
                });
            }

            return allCalculatedMatches.sort((a, b) => b.similarity - a.similarity);
        }

        // Fun√ß√£o para copiar texto para a √°rea de transfer√™ncia
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                return true;
            }
        }

        // Fun√ß√£o para criar o HTML de uma correspond√™ncia
        function createMatchHTML(stockProduct, matches, showWarning) {
            const matchItems = matches.map(match => {
                let badgeClass = 'similarity-low';
                if (match.similarity >= 60) badgeClass = 'similarity-high';
                else if (match.similarity >= 40) badgeClass = 'similarity-medium';

                return `
                    <div class="match-item">
                        <div class="match-info">
                            <div class="match-name">${match.ds_produto}</div>
                            <div class="match-details">
                                <span class="product-code">${match.cd_produto}</span> ‚Ä¢
                                <strong>Unidade:</strong> ${match.unidade || 'N/A'} ‚Ä¢
                                <strong>Categoria:</strong> ${match.ds_classe || 'N/A'}
                                ${match.ds_sub_cla ? ` ‚Ä¢ <strong>Sub:</strong> ${match.ds_sub_cla}` : ''}
                            </div>
                        </div>
                        <div class="similarity-badge ${badgeClass}">${match.similarity}%</div>
                        <button class="copy-btn" onclick="copyProductInfo(event, ${match.cd_produto}, '${match.ds_produto.replace(/'/g, "\\'")}')">
                            üìã Copiar
                        </button>
                    </div>
                `;
            }).join('');
            
            const allProductsString = matches.map(match =>
                `${match.cd_produto}\t${match.ds_produto}\t${match.unidade}\t${match.ds_classe}\t${match.ds_sub_cla || ''}`
            ).join('\n');

            return `
                <div class="product-match">
                    <div class="stock-product">
                        <h3>${stockProduct.produto}</h3>
                        <div class="stock-info">
                            <span><strong>C√≥digo:</strong> <span class="product-code">${stockProduct.codigo}</span></span>
                            <span><strong>Qtd:</strong> ${stockProduct.qtdeAtual || 'N/A'}</span>
                        </div>
                    </div>
                    ${showWarning && matches.length > 0 ? `
                    <div class="low-similarity-warning">
                        <h4>‚ö†Ô∏è Aviso de Baixa Similaridade</h4>
                        <p>Nenhuma correspond√™ncia com ${HIGH_SIMILARITY_THRESHOLD}%+ foi encontrada. Exibindo as ${matches.length} op√ß√µes mais pr√≥ximas.</p>
                    </div>` : ''}
                    <div class="matches">
                        ${matches.length > 0 ? matchItems : `
                        <div class="no-matches-found">
                            <p>Nenhuma correspond√™ncia encontrada no invent√°rio para este item.</p>
                        </div>`}
                        
                        ${matches.length > 1 ? `
                        <button class="copy-all-btn" onclick="copyAllProducts(event, '${allProductsString.replace(/'/g, "\\'")}', '${stockProduct.produto.replace(/'/g, "\\'")}')">
                            üìã Copiar Todas as ${matches.length} Op√ß√µes
                        </button>` : ''}
                    </div>
                </div>
            `;
        }

        // Fun√ß√£o para copiar informa√ß√µes do produto individual
        async function copyProductInfo(event, codigo, nome) {
            event.stopPropagation();
            const text = `${codigo}\t${nome}`;
            const success = await copyToClipboard(text);

            if (success) {
                const btn = event.target.closest('.copy-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copiado!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#17a2b8';
                }, 1500);
            }
        }

        // Fun√ß√£o para copiar todas as op√ß√µes relacionadas
        async function copyAllProducts(event, allProductsString, produtoOriginal) {
            event.stopPropagation();
            const header = `PRODUTO ORIGINAL: ${produtoOriginal}\n\nC√≥digo\tDescri√ß√£o\tUnidade\tClasse\tSubclasse\n`;
            const text = header + allProductsString;
            const success = await copyToClipboard(text);
            
            if (success) {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Todas Copiadas!';
                btn.style.background = '#218838';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '#28a745';
                }, 2000);
            }
        }

        // Fun√ß√£o para renderizar resultados com pagina√ß√£o
        function renderResults(matchesData, totalStock, totalWithMatches) {
            const resultsDiv = document.getElementById('results');

            if (matchesData.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                        <h3>Nenhuma correspond√™ncia encontrada</h3>
                        <p>Tente refinar seu termo de busca ou verifique o nome do produto.</p>
                    </div>
                `;
                return;
            }
            
            allMatchesData = matchesData;
            totalItems = matchesData.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentPageMatches = matchesData.slice(startIndex, endIndex);

            const statsHTML = `
                <div class="pagination-summary">
                    üìä Exibindo ${currentPageMatches.length} de ${totalItems} produtos do estoque.
                    (Total com correspond√™ncias: ${totalWithMatches})
                </div>
            `;
            
            const matchesHTML = currentPageMatches.map(data =>
                createMatchHTML(data.stockProduct, data.matches, data.showWarning)
            ).join('');

            const paginationHTML = createPaginationHTML(totalPages);
            resultsDiv.innerHTML = statsHTML + matchesHTML + paginationHTML;
        }

        // Fun√ß√£o para criar HTML da pagina√ß√£o
        function createPaginationHTML(totalPages) {
            if (totalPages <= 1) return '';
            let paginationHTML = '<div class="pagination">';
            paginationHTML += `<button ${currentPage <= 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">‚óÄ Anterior</button>`;

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) paginationHTML += `<button onclick="changePage(1)">1</button>${startPage > 2 ? `<span>...</span>` : ''}`;

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            if (endPage < totalPages) paginationHTML += `${endPage < totalPages - 1 ? `<span>...</span>` : ''}<button onclick="changePage(${totalPages})">${totalPages}</button>`;

            paginationHTML += `<button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">Pr√≥ximo ‚ñ∂</button>`;
            paginationHTML += '</div>';
            return paginationHTML;
        }

        // Fun√ß√£o para mudar p√°gina
        function changePage(page) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderResults(allMatchesData, window.stockProducts ? window.stockProducts.length : 0, allMatchesData.filter(m => m.matches.length > 0).length);
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // Fun√ß√£o para mudar itens por p√°gina
        function changeItemsPerPage() {
            const currentFirstItem = (currentPage - 1) * itemsPerPage + 1;
            itemsPerPage = parseInt(document.getElementById('itemsPerPageSelect').value);
            currentPage = Math.ceil(currentFirstItem / itemsPerPage);
            if (allMatchesData.length > 0) {
                renderResults(allMatchesData, window.stockProducts ? window.stockProducts.length : 0, allMatchesData.filter(m => m.matches.length > 0).length);
            }
        }

        // Fun√ß√£o principal para processar todos os produtos
        async function processAll() {
            const resultsDiv = document.getElementById('results');
            const searchTerm = document.getElementById('searchInput').value;
            currentPage = 1;

            resultsDiv.innerHTML = `<div class="loading"><h3>‚öôÔ∏è Processando...</h3></div>`;
            await new Promise(resolve => requestAnimationFrame(resolve));

            try {
                if (!window.stockProducts || !window.inventoryProducts) {
                    await loadData();
                }

                let stockProducts = window.stockProducts || [];
                const inventoryProducts = window.inventoryProducts || [];

                if (searchTerm) {
                    const normalizedSearch = normalizeText(searchTerm);
                    stockProducts = stockProducts.filter(product => normalizeText(product.produto).includes(normalizedSearch));
                }

                const allMatches = [];

                for (const stockProduct of stockProducts) {
                    const allPotentialMatches = findMatches(stockProduct, inventoryProducts);
                    const highQualityMatches = allPotentialMatches.filter(match => match.similarity >= HIGH_SIMILARITY_THRESHOLD);

                    let matchesToShow;
                    let needsWarning = false;

                    if (highQualityMatches.length > 0) {
                        matchesToShow = highQualityMatches;
                    } else if (allPotentialMatches.length > 0) {
                        matchesToShow = allPotentialMatches.slice(0, 3);
                        needsWarning = true;
                    } else {
                        matchesToShow = [];
                    }
                    
                    allMatches.push({
                        stockProduct,
                        matches: matchesToShow,
                        showWarning: needsWarning
                    });
                }
                
                renderResults(allMatches, stockProducts.length, allMatches.filter(m => m.matches.length > 0).length);
            } catch (error) {
                console.error('Erro ao processar:', error);
                resultsDiv.innerHTML = `<div class="no-results"><h3>‚ö†Ô∏è Erro ao processar dados</h3><p>${error.message}</p></div>`;
            }
        }
        
        // Fun√ß√£o para carregar dados dos arquivos JSON
        async function loadData() {
            try {
                const [stockResponse, inventoryResponse] = await Promise.all([
                    fetch('estoque.json'),
                    fetch('inventario.json')
                ]);

                if (!stockResponse.ok || !inventoryResponse.ok) {
                    throw new Error('N√£o foi poss√≠vel encontrar os arquivos estoque.json ou inventario.json');
                }

                window.stockProducts = await stockResponse.json();
                window.inventoryProducts = await inventoryResponse.json();
                console.log(`Dados carregados: ${window.stockProducts.length} itens de estoque, ${window.inventoryProducts.length} itens de invent√°rio.`);
                return true;

            } catch (error) {
                console.error('Erro ao carregar arquivos JSON:', error);
                throw error;
            }
        }

        // Event Listeners
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                if (this.value.length >= 3 || this.value.length === 0) {
                    processAll();
                }
            }, 800);
        });
        
        // Inicializa√ß√£o da aplica√ß√£o
        window.addEventListener('load', async () => {
            try {
                await loadData();
                processAll();
            } catch (e) {
                document.getElementById('results').innerHTML = `
                    <div class="no-results">
                        <h3>‚ö†Ô∏è Erro ao carregar dados</h3>
                        <p>Verifique se os arquivos <code>estoque.json</code> e <code>inventario.json</code> est√£o no mesmo diret√≥rio que este arquivo HTML e tente novamente.</p>
                        <button class="btn" onclick="location.reload()">Tentar Novamente</button>
                    </div>`;
            }
        });
    </script>
</body>
</html>
